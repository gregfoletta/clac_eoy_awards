---
title: "Little Aths Points"
author: "Greg Foletta"
output:
  word_document: default
date: "2025-03-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```



```{r include=FALSE}
library(tidyverse)
library(openxlsx)
library(janitor)
library(V8)
library(httr2)
library(gt)
library(glue)
```

**Note**: this document has been auto-generated by a script using multiple data sources. Accuracy is preferred over aesthetics.

# Background of Data Sources

- Season PBs, attendance, places, and centre record points are all generated from Results HQ
  - Points and criteria for these are configured within ResultsHQ.
  - Only standard Coburg weeks are selected.
  - This is double checked to ensure no data is used from non-Coburg events that have been uploaded to Results HQ (e.g 'Region Combined Event' and 'All Star Day'). 
- State and State Combined athletes and results are pulled down directly from LA Vic Results Hub
  - If an athlete was registered but did not participate in any events, they are not given any points.
  - If an athlete participated in *at least* one event they were registered in, they recieve points.
- LA Vic Results hub does not have athlete names for State Relay.
  - Participating athletes have been extracted from the 'Volunteer duties and teams' CLAC spreadsheet.
  - **Note**: given the nature of this spreadsheet, there is room for error here.
  
# Summary of Points Procedure

- For each athlete, sum of the season PBs, attendance, place, and centre record points is calculated.
- Athletes who participated in state receive an extra 5 points.
- Athletes who participated in state relays receive an extra 5 points.
- Athletes who participated in state combined receive an extra 5 points.

# Caveats

- A number of athletes have multiple results per individual race, giving them one or more extra points for attendance, and potentially points for a PB that is not a realised PB. Further discussion and a decision is required on how to rectify these.
  - Please see the appendex at the end of this document for a list of those athletes and events.
- Given the potential for error with relay attendance, athletes receiving awards that are within 5 points of others, manual checking of state relay attendance shouldbe performed.
  - This throws out the 'points per club' calculations.
  - If I can be advised which club he's in, I can recalculate.

```{r include=FALSE}
# Read in raw data thats been eported from ResultsHQ
aths_data <-
    read_csv('2024_2025_Calculated_Points.csv', show_col_types = FALSE) |> 
    as_tibble() |>
    clean_names() |>
    mutate(first_name = tolower(name), last_name = tolower(surname)) |>
    select(first_name, last_name, everything(), -c(name, surname))

# Explicity filter out non-race days
non_race_days <-
    tibble(
        date = c('05 Oct 2024', '20 Oct 2024', '01 Dec 2024', '12 Jan 2025', '19 Jan 2025', '02 Feb 2025', '02 Mar 2025', '15 Mar 2025', '21 Mar 2025', '22 Mar 2025'),
    )

aths_data <-
    aths_data |> 
    anti_join(non_race_days)

aths_data |> count(date)
```

```{r}
# Summarise PB, attendance, place, centre record
aths_summary <-
    aths_data |>
    group_by(first_name, last_name) |>
    summarise(
        pb = sum(season_pb),
        attendance = sum(attend),
        place = sum(place),
        cr = sum(cr),
        age = first(age),
        gender = first(gender),
        club = first(club)
    ) |>
    ungroup()
```

```{r}
# Get the region T&F, region combined, and region relay data for Coburg people
region_raw <-
    request('https://lavic.resultshub.com.au/php/resultsFileFetch.php?season=2024&series=regions&round=3&venue=undefined') |>
    req_perform() |>
    resp_body_string()

region_relay_raw <-
    request('https://lavic.resultshub.com.au/php/resultsFileFetch.php?season=2024&series=regions&round=2&venue=undefined') |>
    req_perform() |>
    resp_body_string()

state_combined_raw <-
    request('https://lavic.resultshub.com.au/php/resultsFileFetch.php?season=2024&series=champs&round=2&venue=all') |> 
    req_perform() |>
    resp_body_string()
```


```{r include=FALSE}
# Region
jsonctx <- v8()
jsonctx$eval(region_raw)
# Extract the two JS variables that we need
region_athletes_var <- jsonctx$get('Object.keys(this)') |> as_tibble() |> filter(str_detect(value, 'athletes_NMR')) |> pull(value)
region_results_var <- jsonctx$get('Object.keys(this)') |> as_tibble() |> filter(str_detect(value, 'results_NMR')) |> pull(value)

# Get the athletes
region_athletes <- jsonctx$get(region_athletes_var) |>
    as_tibble() |>
    clean_names() |>
    filter(affiliation == 5) 

# Get the results
region_results <- jsonctx$get(region_results_var) |>
  as_tibble() |>
  clean_names()

# Join the athletes and results together
region_athletes <-
region_athletes |>
  left_join(region_results, by = 'athlete_id') |>
  group_by(athlete_id) |>
  filter(!all(perf_dsp == 'DNS')) |>
  ungroup() |> 
  distinct(first_name, last_name) |>
  # Lower case to match the aths summary
  mutate(first_name = tolower(first_name), last_name = tolower(last_name)) |>
  # Add the points column
  mutate(region_pts = 5)
  
rm(jsonctx)
```

```{r}
### Check that there's no one in the region list that isn't in our aths summary list
# region_athletes |> anti_join(aths_summary, by = c('first_name', 'last_name')) |> gt()
```

```{r}
# 2025:Sri has an 'L' initial in her name in our main points data. Removing this L ensures her name matches across the datasets.
# Manually fix up Sri's name so it matches
aths_summary <-
aths_summary |>
    mutate(
        first_name = case_when(
            first_name == 'sri  l' ~ 'sri',
            .default = first_name
        )
    )

# Region data into the summary
aths_summary <-
    aths_summary |>
    left_join(region_athletes, by = c('first_name', 'last_name')) |>
    mutate(region_pts = replace_na(region_pts, 0))
```


```{r include=FALSE}
#### State combined
jsonctx <-v8()
jsonctx$eval(state_combined_raw)
combined_athletes_var <- jsonctx$get('Object.keys(this)')|> as_tibble() |> filter(str_detect(value, 'athletes_')) |> pull(value)
combined_results_var <- jsonctx$get('Object.keys(this)')|> as_tibble() |> filter(str_detect(value, 'results_')) |> pull(value)

# Get the athletes
combined_athletes <- jsonctx$get(combined_athletes_var) |>
    as_tibble() |>
    clean_names() |>
    filter(affiliation == 5) 

# Get the results
combined_results <- jsonctx$get(combined_results_var) |>
    as_tibble() |>
    clean_names()

# Join the athletes and results together
combined_athletes <-
combined_athletes |>
  left_join(combined_results, by = 'athlete_id') |>
  # Filter out any athletes who didn't compete in a single event
  group_by(athlete_id) |>
  filter(!all(perf_dsp == 'DNS')) |>
  ungroup() |> 
  distinct(first_name, last_name) |>
  # Lower case to match the aths summary
  mutate(first_name = tolower(first_name), last_name = tolower(last_name)) |>
  # Add the points column
  mutate(combined_pts = 5)

rm(jsonctx)
```

```{r}
# Check combined athletes against the master list
#combined_athletes |> anti_join(aths_summary, by = c('first_name', 'last_name')) |> gt()
```

```{r}
aths_summary <-
    aths_summary |>
    left_join(combined_athletes, by = c('first_name', 'last_name')) |>
    mutate(combined_pts = replace_na(combined_pts, 0))
```


```{r include=FALSE}
#### Region Relays
# This spreadsheet needs a lot of cleaning
relay_athletes <-
  read.xlsx('2024_Relays.xlsx', sheet = 'Volunteer duties and teams', startRow = 23, colNames = FALSE) |>
  as_tibble() |>
  select(age = X1, first = X4, second = X5, third = X6, fourth = X7, reserve = X8) |>
  fill(age) |>
  separate(age, into = c('min_age', 'max_age'), sep = '&') |>
  pivot_longer(c(min_age, max_age), names_to = 'age_span', values_to = 'age') |>
  mutate(age = str_extract(age, '\\d+')) |>
  filter(!is.na(age)) |> 
  pivot_longer(c(first, second, third, fourth, reserve), names_to = 'leg', values_to = 'name') |>
  filter(!is.na(name)) |>
  filter(!str_detect(name, '1|2|3|4|Reserve|Yes')) |>
  separate(name, into = c('first_name', 'other'), sep = '\\s+') |>
  mutate(first_name = tolower(first_name)) |>
  distinct(age, first_name) |>
  mutate(age = as.double(age)) |>
  mutate(relay_pts = 5) 
  # Some participated in higher age groups. Get the lowest age group they were in
```
```{r}
# Merge in the relay athletes
aths_summary <-
  aths_summary |>
  left_join(relay_athletes, by = c('first_name', 'age')) |>
  mutate(relay_pts = replace_na(relay_pts, 0))
```

# Athlete of the Year

```{r}
total_points <-
    aths_summary |>
    # Calculate the total points
    mutate(total_points = pb + attendance + place + cr + region_pts + combined_pts) |>
    # Add in the 'groups', which is used for one of the awards
    #mutate(group = cut(age, breaks = c(6,8,12,17), include.lowest = TRUE, right = TRUE, labels = c('6-8', '9-12', '13-17'))) |>
    arrange(desc(total_points)) |>
    select(first_name, last_name, gender, age, club, everything())
```

## Females 
```{r}
total_points |>
  filter(gender == 'F') |> 
  slice_max(total_points, n = 3) |>  
  gt()
```

## Males
```{r}
total_points |>
  filter(gender == 'M') |> 
  slice_max(total_points, n = 3) |>  
  gt()
```

# Best in Age & Gender (Top 3)

## Females
```{r}
total_points |>
  filter(gender == 'F') |> 
  mutate(age_label = glue("Under {age}{gender}")) |> 
  group_by(age) |> 
  slice_max(total_points, n = 3) |>
  ungroup() |> 
  select(first_name, last_name, everything(), total_points) |>  
  gt(groupname_col = 'age_label') 
```

## Males

```{r}
total_points |>
  filter(gender == 'M') |> 
  mutate(age_label = glue("Under {age}{gender}")) |> 
  group_by(age) |> 
  slice_max(total_points, n = 3) |>
  ungroup() |> 
  select(first_name, last_name, everything(), total_points) |>  
  gt(groupname_col = 'age_label') 
```

# Club of the Year

**Note**: Harper Crotty was registered against "Coburg Little Athletics Centre". They have been moved to 'Westbreen'.

```{r}
total_points <-
  total_points |>
  mutate(club = if_else(first_name == 'harper' & last_name == 'crotty', "Westbreen - Coburg LAC", club))
```


## Total Points

```{r}
total_points |>
  group_by(club) |>
  summarise(total_points = sum(total_points)) |>
  arrange(desc(total_points)) |>
  gt()
```

## Average Points per Athlete

```{r}
total_points |>
  group_by(club) |>
  summarise(mean_pts_per_athlete = mean(total_points)) |>
  arrange(desc(mean_pts_per_athlete)) |>
  gt()
```

# Centre Records

```{r include=FALSE}
centre_records <-
  read_csv('CentreRecords.csv', show_col_types = FALSE) |>
  clean_names() |> 
  mutate(date = dmy(createddatetime)) |> 
  filter(year(date) < 2026) |> 
  select(date, membername, event = shortname, record_value, gender, agegroup, clubname) 
```

## Records 2024 - 2025

```{r}
# Generate the 2024-25
centre_records |>
  filter(date > dmy('6/6/2024')) |>
  arrange(membername) |> 
  gt()
```

## Records Last Comp and Club Champs

These are the records that were gained on:

- 16/3/2024 (Last Competition)
- 22/3/2024 (Centre Champs Day 1)
- 23/3/2024 (Centre Champs Day 2)

```{r}
centre_records |>
  filter(
    date == '2024-3-16' |
    date == '2024-3-22' |
    date == '2024-3-23'
  ) |>
  arrange(membername) |> 
  gt()
```

# 100% Attendance
```{r include=FALSE}
##### Check
# Count up all the events every person has assigned, then ensure everyone has the same
# number of events for each date
aths_data |>
    count(date, event_name, first_name, last_name) |>
    group_by(date, event_name) |>
    summarise(var = var(n))
    
```

```{r include=FALSE}
total_events_per_age <- 
    aths_data |>
    group_by(age, gender, first_name, last_name) |>
    count() |>
    ungroup(first_name, last_name) |>
    summarise(total_events_per_age = mean(n)) |>
    ungroup()

percent_participaton <-
    aths_data |>
    filter(heat_type != 'DNS') |>
    count(first_name, last_name, club, age, gender, name = 'events') |>
    left_join(total_events_per_age, by = c('age', 'gender')) |>
    mutate(percentage = round(events/total_events_per_age, digits = 8)) |>
    arrange(desc(percentage))
```

```{r}
percent_participaton |>
    filter(percentage == 1) |>
    mutate(percentage = scales::label_percent()(percentage)) |> 
    gt()
```

# Personal Best Awards

Personal best is calculated as (number of PBs) / (number of events competed in). There is a threshold of needing to have competed in at least 50% or more of the events to be eligible.

```{r}
pb_awards <-
    aths_data |>
    group_by(first_name, last_name, age, gender, club) |>
    summarise(pbs = sum(season_pb)) |>
    left_join(percent_participaton, by = c('first_name', 'last_name', 'age', 'gender', 'club')) |>
    mutate(
        percent_competed = events / total_events_per_age,
        percent_pb_competed = pbs / events
    ) |>
    # Must have competed in at least 50% of the events
    filter(percent_competed >= .5) |> 
    select(first_name, last_name, gender, age, club, pbs, total_events_per_age, events, percent_competed, percent_pb_competed) |>
    ungroup()
```

## 75% Or More Personal Best

No athletes were 75% or above.

```{r include=FALSE}
pb_awards |>
    filter(percent_pb_competed >= .75) |>
    arrange(desc(percent_pb_competed)) |>
    mutate(percent_pb_competed = scales::label_percent()(percent_pb_competed)) |> 
    gt()
```

## 50% Or More Personal Best

```{r}
pb_awards |>
    filter(percent_pb_competed >= .5) |>
    arrange(desc(percent_pb_competed)) |>
    mutate(
      percent_competed = scales::label_percent()(percent_competed),
      percent_pb_competed = scales::label_percent()(percent_pb_competed)
    ) |> 
    gt()
```

    